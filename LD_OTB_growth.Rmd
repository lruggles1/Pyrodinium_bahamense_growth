---
title: "Low-diversity growth curves"
output: html_document
date: "2025-06-09"
---

# Install packages 
```{r import packages}
library(googlesheets4) #scrapes google sheets
library(dplyr) # dataframe manipulation
library(ggplot2) # plotting package
library(lubridate)
library(tidyr)
library(readr)
library(scales)
```
#Source function for growth curves
```{r}
source("~/Desktop/pyro/vitamin_growth_exp/plot_growthfunction.R")
```
# Create a color pallete
```{r my palette}
pp_palette <- c(
  "#7D8F69",  
  "#C09F80", 
  "#F5C45E",  
  "#C1D3D5",  
  "#B4975A" ,  
  "#8A2D3B",
  "#102E50"
)

scales::show_col(pp_palette)
```
# Import data
```{r import data}
fluor<-as.data.frame(read_csv("fluor.csv"))
fluor$Time <- as.numeric(sub('.', '', fluor$Time))
fluor$Date <- mdy(fluor$Date)
fluor$Time <- fluor$Time * 48 /24
```
#Use function to pllot growth curves
```{r}
growth_LD <- plot_func(fluor, fluor$Time, fluor$`Chlorophyll-A (RFU)`, facet_col = "Round")
growth_LD
ggsave("LD_growth_curves.png", width = 10, height = 7)
```

# Calculate mean Chlorphyll-a and standard deveation
```{r}
# Summarize mean/sd
combined_avg <- fluor %>%
  group_by(Time,Treatment, Round) %>%
  summarise(
    mean_chl = mean(`Chlorophyll-A (RFU)`, na.rm = TRUE),
    sd_chl = sd(`Chlorophyll-A (RFU)`, na.rm = TRUE),
    .groups = "drop"
  )
```
# Plot growth curves 
```{r}
LD_OTB_all_growth <- ggplot(
  combined_avg %>% 
    filter(Treatment %in% c("-Cobalamin", "Replete", "-Biotin", "-Thiamine")),
  aes(x = Time, y = mean_chl)
) +
  # Error bars
  geom_errorbar(
    aes(ymin = mean_chl - sd_chl, ymax = mean_chl + sd_chl,
        group = interaction(Treatment, Round)),
    width = 0.3, color = "black", alpha = 0.6
  ) +
  
  # Lines and points
  geom_line(aes(group = interaction(Treatment, Round), color = Treatment)) +
  geom_point(shape = 21, fill = "white", aes(color = Treatment), stroke = 1.2, size = 2) +
  
  # Manual color scale for treatments (legend labels)
  scale_color_manual(
    values = c(
      "-Cobalamin" = "#102E50",
      "Replete"    = "#F5C45E",
      "-Thiamine"  = "deeppink4",
      "-Biotin"    = "#667028"
    ),
    labels = c(
      "-Cobalamin" = expression(" —B"[12]),  
      "-Thiamine"  = expression("—thiamine"),
      "-Biotin"    = expression("—biotin"),
      "Replete"    = "replete"
    ),
    name = "Treatment"
  ) +
  
  labs(
    x = "Time (days)",
    y = expression(paste("Chlorophyll-", italic("a"), " fluorescence (RFU)"))
  ) +
  facet_grid(~Round) +
  theme_minimal() +
  theme(
    panel.border = element_rect(fill = NA, color = "black"),
    panel.grid = element_blank(),
    axis.title = element_text(family= "Arial", size = 20),
    axis.text = element_text(family= "Arial", size = 20, color = "black"),
    strip.text = element_text(family= "Arial", size = 20, color = "black"),
    legend.title = element_text(family= "Arial", size = 18, color = "black"),
    legend.text = element_text(family= "Arial", size = 18, color = "black"),
    legend.position = "bottom"
  )




LD_OTB_all_growth 

ggsave("LD_growth_curves.png", width = 10, height = 7)
```

# Calculate maximum biomass
```{r max biomass}
# calculate maximum chlorphyll-a fluoresence values for each round and medium treatment
max_bio <- fluor %>%
  filter(Round %in% c(1, 2, 3, 4)) %>%
  filter(Treatment %in% c("-Cobalamin", "Replete", "-Biotin", "-Thiamine")) %>%
  group_by(Treatment, Round, Rep) %>%
  summarise(Max_Chl = max(`Chlorophyll-A (RFU)`, na.rm = TRUE), .groups = "drop")

print(max_bio)
```
# Prepare data for plotting
```{r}

# Calculate mean and SD
summary_stats <- max_bio %>%
  group_by(Treatment, Round) %>%
  summarise(
    mean_chl = mean(Max_Chl, na.rm = TRUE),
    sd_chl   = sd(Max_Chl, na.rm = TRUE),
    .groups = "drop"
  )

# Make Treatment a factor in both datasets
max_bio$Treatment <- factor(max_bio$Treatment, 
                            levels = c( "-Biotin", "-Cobalamin","-Thiamine", "Replete"))

summary_stats$Treatment <- factor(summary_stats$Treatment, 
                                  levels = c("-Cobalamin", "-Thiamine", "-Biotin", "Replete"))
```

# Plot maximum biomass
```{r}

# Define comparisons
signif_comparisons <- list(
  c("Replete", "-Biotin"),
  c("Replete", "-Thiamine"),
  c("-Cobalamin", "Replete")
)

max_bio_LD <- ggplot(max_bio, aes(x = Treatment, y = Max_Chl, color = Treatment)) +
  
  # Raw points with jitter
  geom_point( size = 3, shape = 16, position = position_jitter(width = 0.1)) +
  
  # Error bars for mean ± SD
   geom_errorbar(
    data = summary_stats,
     aes(x = Treatment, y = mean_chl, ymin = mean_chl - sd_chl, ymax = mean_chl + sd_chl, color = Treatment),
     position = position_dodge(width = 0.6),
     width = 0.2,
     linewidth = 0.7,
     inherit.aes = FALSE
   ) +

  # # Open circle for mean
   geom_point(
     data = summary_stats,
     aes(x = Treatment, y = mean_chl, color = Treatment),
     shape = 21,
     fill = "white",
     size = 3,
     stroke = 1,
     position = position_dodge(width = 0.6),
     inherit.aes = FALSE
   ) +
#Option to add significant comparison bars
#   geom_signif(
#   comparisons = signif_comparisons,
#   y_position = c(
#     1.1*max(max_bio$Max_Chl),
#     1.15*max(max_bio$Max_Chl),
#     1.2*max(max_bio$Max_Chl)
#   ), color = "black",
#   tip_length = 0.03,
#   annotations = c("", "", "")
# ) +
  # Facet by Round
  facet_grid(~Round) +
  
  # Axis labels
  labs(
    x = "Serial transfer",
    y = expression(paste("Maximum Chlorophyll-", italic("a"), " fluorescence achieved (RFU)"))) +
 scale_color_manual(
  values = c(
    "-Cobalamin" = "#102E50",
    "-Thiamine"  = "deeppink4",
    "-Biotin"    = "#667028",
    "Replete"    = "#F5C45E"
  ),
  labels = c(
    "-Cobalamin" = expression("—B"[12]),
    "-Thiamine"  = expression("—Thiamine"),
    "-Biotin"    = expression("—Biotin"),
    "Replete"    = "Replete" ),
  name = "Treatment",
  guide = guide_legend(
    override.aes = list(
      shape = 21,        # match the points
      fill = "white",    # match fill
      stroke = 1.2,      # match line width of points
      size = 2,          # match point size
      linetype = 1       # match line type
    ))) +
  scale_x_discrete(
  labels = c(
    "-Biotin"    = expression("\u2013Biotin"),         # en-dash
    "-Cobalamin" = expression("\u2013B"[12]),          # en-dash + subscript 12
    "-Thiamine"  = expression("\u2013Thiamine"),      
    "Replete"    = "Replete"
  )) +
  scale_y_continuous(labels = comma)+
  # Theme
  theme_minimal() +
    theme(
      panel.border = element_rect(fill = NA, color = "black"),
      panel.grid = element_blank(),
      axis.text.y = element_text(size = 16, color = "black"),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 16, color = "black"),
      axis.title.y = element_text(family= "Arial", size = 20),
      axis.title.x = element_text(size = 20, margin = margin(t = 10)),
      strip.text.x = element_text(size = 20),
      strip.text = element_text(family= "Arial", size = 20, color = "black"),
      legend.title = element_text(family= "Arial", size = 16, color = "black"),
      legend.text = element_text(family= "Arial", size = 16, color = "black"),
      legend.position = "none",
        legend.key.size = unit(1.5, "cm")
    )
  
 max_bio_LD 
ggsave("LD_max_bio.png", width = 7, height = 10)
```
# Combine plots
```{r}
library(patchwork)

combo <- (max_bio_LD + growth_LD) + 
         plot_layout(guides = "collect") & 
         theme(legend.position = "bottom",
                legend.justification = "center")

combo  
```
# Serial transfer 1 Calculate maximum biomass 
```{r}
max_bio_1 <- fluor %>% filter(Round %in% c(1)) %>% # change serial transfer for calculations
  filter(Treatment %in% c("-Cobalamin", "Replete", "-Thiamine","-Biotin")) %>%
  group_by(Treatment, Round, Rep) %>% 
  summarise(Max_Chl = max(`Chlorophyll-A (RFU)`, na.rm = TRUE)) %>%
  ungroup()
```
# Serial transfer 1 ANOVA and post-hoc multiple comparisons
```{r}
aov_max_1<-  aov(Max_Chl ~ Treatment, data = max_bio_1)
TukeyHSD(aov_max_1)
summary(aov_max_1)
```
# Serial transfer 2 Calculate maximum biomass 
```{r}
max_bio_2 <- fluor %>% filter(Round %in% c(2)) %>% # change serial transfer for calculations
  filter(Treatment %in% c("-Cobalamin", "Replete", "-Thiamine","-Biotin")) %>%
  group_by(Treatment, Round, Rep) %>% 
  summarise(Max_Chl = max(`Chlorophyll-A (RFU)`, na.rm = TRUE)) %>%
  ungroup()

max_bio_2 %>%
  group_by(Treatment) %>%
  summarise(mean = mean(Max_Chl),
            sd   = sd(Max_Chl),
            n    = n())
```
# Serial transfer 2 ANOVA and post-hoc multiple comparisons
```{r}
aov_max_2<-  aov(Max_Chl ~ Treatment, data = max_bio_2)
TukeyHSD(aov_max_2)
summary(aov_max_2)
```
# Serial transfer 3 Calculate maximum biomass 
```{r}
max_bio_3 <- fluor %>% filter(Round %in% c(3)) %>% # change serial transfer for calculations
  filter(Treatment %in% c("-Cobalamin", "Replete", "-Thiamine","-Biotin")) %>%
  group_by(Treatment, Round, Rep) %>% 
  summarise(Max_Chl = max(`Chlorophyll-A (RFU)`, na.rm = TRUE)) %>%
  ungroup()

```
# Serial transfer 3 ANOVA and post-hoc multiple comparisons
```{r}
aov_max_3<-  aov(Max_Chl ~ Treatment, data = max_bio_3)
TukeyHSD(aov_max_3)
summary(aov_max_3)
```
# Serial transfer 4 Calculate maximum biomass 
```{r}
max_bio_4 <- fluor %>% filter(Round %in% c(4)) %>% # change serial transfer for calculations
  filter(Treatment %in% c("-Cobalamin", "Replete", "-Thiamine","-Biotin")) %>%
  group_by(Treatment, Round, Rep) %>% 
  summarise(Max_Chl = max(`Chlorophyll-A (RFU)`, na.rm = TRUE)) %>%
  ungroup()
```
# Serial transfer 4 ANOVA and post-hoc multiple comparisons
```{r}
aov_max_4 <-  aov(Max_Chl ~ Treatment, data = max_bio_4)
TukeyHSD(aov_max_4)
summary(aov_max_4)
```

```{r}
aov_all <- aov(Max_Chl ~ Treatment*Rep , data = bind_rows(max_bio_1, max_bio_2, max_bio_3, max_bio_4))
summary(aov_all)

TukeyHSD(aov_all)

```
