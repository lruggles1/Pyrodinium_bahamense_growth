---
title: "b12_levels"
output: html_document
date: "2025-06-09"
---

# Install packages 
```{r}
#install.packages("googlesheets4)
library(googlesheets4) #scrapes google sheets
library(dplyr) # dataframe manipulation
library(ggplot2) # plotting package
library(lubridate)
library(tidyr)
library(scales)
library(growthrates)
library(ggsignif)
library(readr)

```

# Import and parse data
```{r import data}
b12 <-as.data.frame(read_csv("b12_levels.csv")) 
# Remove periods and convert to numeric
b12$Time <- as.numeric(sub("T", "", b12$Time))
# Convert Date column to Date type
b12$Date <- mdy(b12$Date)
b12$Treatment <- unlist(b12$Treatment)
#covert timepoints to hours
b12$Time <- b12$Time * 48    # hours
b12$Time <- b12$Time / 24

# put treatment level in desired order
b12 <- b12 %>%
  mutate(Treatment = factor(Treatment, levels = c(
    "369pM",    # Place the levels in desired order
    "36pM",
    "3.69pM",
    "0.369pM",
    "0.0369pM"
  )))

```
# Calculate mean Chlorphyll-a and standard devation 
```{r Summarize mean/sd}
combined_avg <- b12 %>%
  group_by(Time,Treatment, Round) %>%
  summarise(
    mean_chl = mean(`Chlorophyll-A (RFU)`, na.rm = TRUE),
    sd_chl = sd(`Chlorophyll-A (RFU)`, na.rm = TRUE),
    .groups = "drop"
  )


# Plot growth curves
```

```{r plot growth}
# Define the order of treatments
levels_order <- c("0.0369pM", "0.369pM", "3.69pM", "36pM", "369pM")
b12$Treatment <- factor(b12$Treatment, levels = levels_order)

# Named color palette
pp_palette <- c(
  "0.0369pM" = "lightblue",
  "0.369pM"  = "#99c2e6",
  "3.69pM"   = "#66a3d2",
  "36pM"     = "#3380bf",
  "369pM"    = "#004080"
)
```

#plot growth curves
```{r}
# Paper plot
# Now your ggplot will respect the low-to-high order
growth <- ggplot(b12, aes(x = Time, y = `Chlorophyll-A (RFU)`, color = Treatment)) +
  geom_point() +
  geom_smooth(aes(color = Treatment), se = FALSE) +
  facet_grid(Round ~ Treatment) +
  labs(
    x = "Time (days)",
    y = expression(paste("Chlorophyll-", italic("a"), " fluorescence (RFU)"))
  ) +
  
 
   scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
               labels = trans_format("log10", math_format(10^.x)))+
  


  scale_color_manual(values = pp_palette) +
  theme_minimal() +
  theme(
    panel.border = element_rect(fill = NA, color = "black"),
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20, color = "black"),
    axis.text.x = element_text(hjust = 1, size = 14, color = "black"),
    axis.title.y = element_text(size = 20, margin = margin(t = 10)),
    axis.title.x = element_text(size = 20, margin = margin(t = 10)),
    strip.text.x = element_text(size = 16),
    strip.text = element_text(family = "Arial", size = 16, color = "black"),
    legend.title = element_text(family = "Arial", size = 16, color = "black"),
    legend.text = element_text(family = "Arial", size = 16, color = "black"),
    legend.position = "none"
  )

growth

# ggsave("b12_lev_final.png", width = 10, height = 7)
```




# Mumax calculations amound varing media treatments 
```{r calculate mean max growth rate (µmax)}
# group by serial transfer and media treatment 
b12 %<>%
  group_by( Treatment) %>%
  filter(n() > 4) %>%
  ungroup() %>%
  droplevels() 
  
#find max growth rate/ spar 0.7 allowed for a better representation of the treatments
many_spline_fits <- all_splines(`Chlorophyll-A (RFU)` ~ Time| Treatment + Bio_Rep,
                                data = b12, spar = 0.7)

par(mfrow = c(4, 6))
par(mar = c(2.5, 4, 2, 1))
plot(many_spline_fits)

all_fits <- many_spline_fits@fits

# Loop through and extract mumax and y0
b12_mumax <- data.frame(
  ID = names(all_fits),
  y0 = sapply(all_fits, function(fit) fit@par["y0"]),
  mumax = sapply(all_fits, function(fit) fit@par["mumax"])
)

# View the result
print(b12_mumax)
```

#Remove outliers
```{r}
# ️⃣ Compute T0 baseline per replicate, treatment, and round
baseline <- aggregate(
  `Chlorophyll-A (RFU)` ~ Bio_Rep + Treatment + Round,
  data = subset(b12, Time == 0),
  FUN = mean,
  na.rm = TRUE
)
names(baseline)[names(baseline) == "Chlorophyll-A (RFU)"] <- "Chl_T0"

# Merge baseline back into the full dataset
b12_merged <- merge(b12, baseline, by = c("Bio_Rep", "Treatment", "Round"), all.x = TRUE)

#  Keep all T0 points, and remove any post-T0 points where replicate < its T0
b12_clean <- subset(
  b12_merged,
  Time == 0 | `Chlorophyll-A (RFU)` >= Chl_T0
)


```
                        


# ALL EASY LINEAR
# 0.0369PM
```{r}
pM_1 <- b12_clean %>%
  filter(
    Treatment %in% c("0.0369pM"),
    Round %in% c(1)
  ) %>%                     
  rename(Chl = `Chlorophyll-A (RFU)`) %>%
  arrange(Time, Bio_Rep)

mu1 <- all_easylinear(Chl ~ Time | Round + Treatment + Bio_Rep, pM_1, h =4, quota = 1)

par(mfrow = c(3, 3))
par(mar = c(0.5, 0.5, 0.5, 0.5))
plot(mu1, log = "y")

summary(mu1)
coef(mu1)
rsquared(mu1)

#not significant slopes

```
#maximum growth rate with all easy linear
#0.369pM
```{r}
pM_2 <- b12_clean %>%
  filter(Treatment %in% c("0.369pM"),
         Round %in% c(1),
         Time >= 0) %>%  # <-- exclude T0
  rename(Chl = `Chlorophyll-A (RFU)`) %>%
  arrange(Time, Bio_Rep)

mu2 <-all_easylinear(Chl ~ Time|Treatment+Bio_Rep, pM_2, h = 4, quota = 1)


par(mfrow = c(3, 3))
par(mar = c(0.5, 0.5, 0.5, 0.5))
plot(mu2, log = "y")   # line only


summary(mu2)
coef(mu2)
rsquared(mu2)
#not significant slopes
```
#maximum growth rate with all easy linear
#3.69PM
```{r}
pM_3 <- b12_clean %>%
  filter(Treatment %in% c("3.69pM"),
         Round %in% c(1),
         Time >= 0) %>%  
  rename(Chl = `Chlorophyll-A (RFU)`) %>%
  arrange(Time, Bio_Rep)


mu3 <-all_easylinear(Chl ~ Time|Round+Treatment+Bio_Rep, pM_3, h =5, quota = 1)


par(mfrow = c(3, 3))
par(mar = c(0.5, 0.5, 0.5, 0.5))
plot(mu3 , log = "y")

summary(mu3)
coef(mu3)
rsquared(mu3)
```
#maximum growth rate with all easy linear
#36PM
```{r}
pM_4 <- b12_clean %>% 
  filter(Treatment %in% c("36pM"),
         Round %in% c(1),
         Time >= 0) %>%  # <-- exclude T0
  rename(Chl = `Chlorophyll-A (RFU)`) %>%
  arrange(Time, Bio_Rep)


mu4 <-all_easylinear(Chl ~ Time|Round+Treatment+Bio_Rep, pM_4, h = 5, quota = 1)


par(mfrow = c(3, 3))
par(mar = c(0.5, 0.5, 0.5, 0.5))
plot(mu4 , log = "y")

summary(mu4)
coef(mu4)
rsquared(mu4)
```
#maximum growth rate with all easy linear
#369PM
```{r}
pM_5 <- b12_clean %>% 
  filter(Treatment %in% c("369pM"),
         Round %in% c(1),
         Time >= 0) %>% 
  rename(Chl = `Chlorophyll-A (RFU)`) %>%
  arrange(Time, Bio_Rep)

mu5 <-all_easylinear(Chl ~ Time|Round+Treatment+Bio_Rep, pM_5, h = 5, quota = 1)


par(mfrow = c(3, 3))
par(mar = c(0.5, 0.5, 0.5, 0.5))
plot(mu5 , log = "y")

summary(mu5)
coef(mu5)
rsquared(mu5)
```
# Make datafrane with fits
```{r}
library(dplyr)
library(tibble)
library(googlesheets4)
  make_df <- function(model, round_num, experiment_name) {
  coefs <- coef(model)
  
  if (is.matrix(coefs)) {
    df <- as.data.frame(coefs) %>%
      tibble::rownames_to_column("Group") %>%
      mutate(
        Round = round_num,
        Experiment = experiment_name,
        r2 = rsquared(model)
      )
  } else {
    df <- data.frame(
      Group = names(coefs),
      Estimate = as.numeric(coefs),
      Round = round_num,
      Experiment = experiment_name,
      r2 = rep(rsquared(model), length(coefs))
    )
  }
  
  return(df)
}

# Example usage for your single fits
df1 <- make_df(mu1, 1, "0.0369pM")
df2 <- make_df(mu2, 1, "0.369pM")
df3 <- make_df(mu3, 1, "3.69pM")
df4 <- make_df(mu4, 1, "36pM")
df5 <- make_df(mu5, 1, "369pM")

# Combine all results
all_results <- bind_rows(df1, df2, df3, df4, df5)

# Check
all_results

# Save your dataframe to a new sheet
sheet <- gs4_create(name = "mumax_b12", sheets = list(data = all_results))



```

#ALL easy linear ANOVA
# ANOVA and post-hoc multiple comparisons of mumax among varying media treatments
```{r ANOVA of µmax among b12 levels and post-hoc multiple comparisons}
# Exclude the treatments "0.0369pM" and "0.369pM"
filtered_results <- all_results[ 
  !(all_results$Experiment %in% c("0.0369pM", "0.369pM")), 
]

# Run ANOVA on filtered data
aov_result <- aov(mumax ~ Experiment, data = filtered_results)
summary(aov_result)

# Post-hoc Tukey test
TukeyHSD(aov_result)

```

# Plot mumax with all easy linear data 
```{r mumax of B12 levels}

# Define the order of treatments from least to greatest
levels_order <- c("0.0369pM", "0.369pM", "3.69pM", "36pM", "369pM")

# Convert Treatment column to a factor with this order
all_results$Experiment <- factor(all_results$Experiment, levels = levels_order)

# calculate standard deviation and mean 
b12_summary <- all_results %>%
  group_by(Experiment) %>%
  summarise(
    mean_mumax = mean(mumax, na.rm = TRUE),
    se_mumax   = sd(mumax, na.rm = TRUE)/sqrt(n()),
    .groups = "drop"
  )

# Define comparisons

signif_comparisons <- list(
  c("0.0369pM", "369pM"),
   c("0.369pM", "369pM"),
  c("3.69pM", "369pM"),
  c("36pM", "369pM")
)


# plot data 
mu <- ggplot(all_results, aes(x = Experiment, y = mumax, color = Experiment)) +
  # Raw replicate points (jittered)
  geom_point(size = 5, shape = 16, position = position_jitter(width = 0.1), alpha = 0.6) +
  
  # Mean per experiment (open circle)
  stat_summary(fun = mean, geom = "point", shape = 1, size = 5, stroke = 1.2) +
  
  # Error bars (standard error)
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, linewidth = 0.8) +
  
  # # Significance bars
  # geom_signif(comparisons = signif_comparisons,
  #             y_position = c(1.1*max(all_results$mumax),
  #                            1.15*max(all_results$mumax),
  #                            1.2*max(all_results$mumax),
  #                            1.25*max(all_results$mumax)),
  #             tip_length = 0.03,
  #             annotations = "", color = "black") +
  
  # Color palette
  scale_color_manual(values = c(
    "0.0369pM" = "lightblue",
    "0.369pM"  = "#99c2e6",
    "3.69pM"   = "#66a3d2",
    "36pM"     = "#3380bf",
    "369pM"    = "#004080"
  )) +

  
  # Set visible range safely
  coord_cartesian(ylim = c(0, .4)) +
  
  # Theme and labels
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black"),
    axis.title = element_text(family = "Arial", size = 20),
    axis.text = element_text(family = "Arial", size = 20, color = "black"),
    axis.text.x = element_text(family = "Arial", size = 20, color = "black", angle =45, hjust = 1),
    strip.text = element_text(family = "Arial", size = 20, color = "black")
  ) +
  labs(
    x = expression(B[12]~Concentration~"(pM)"),
    y = expression(paste("(", mu, ") RFU" * "\u00B7" * "day"^-1))
  )

mu


 ggsave("b12mumax.png", width = 10, height =7)
```

# Calculate maximum biomass reached in each B12 concentration
```{r max biomass reached in each B12 concentration}
max_bio <- b12  %>%
  filter(Treatment %in% c(Treatment, levels = c("369pM", "36pM", "3.69pM", "0.369pM", "0.0369pM"))) %>%
  group_by(Treatment, Bio_Rep) %>% 
  summarise(Max_Chl = max(`Chlorophyll-A (RFU)`, na.rm = TRUE)) %>%
  ungroup()

print(max_bio)
```

# Plot maximum biomass
```{r plot max biomass}
library(ggplot2)
library(dplyr)
library(ggsignif)
library(scales)

# Define factor levels (low to high B12)
levels_order <- c("0.0369pM", "0.369pM", "3.69pM", "36pM", "369pM")
max_bio$Treatment <- factor(trimws(max_bio$Treatment), levels = levels_order)

# Calculate summary statistics
summary_stats <- max_bio %>%
  group_by(Treatment) %>%
  summarise(
    mean_chl = mean(Max_Chl, na.rm = TRUE),
    sd_chl   = sd(Max_Chl, na.rm = TRUE),
    .groups = "drop"
  )
summary_stats$Treatment <- factor(summary_stats$Treatment, levels = levels_order)

# Define color palette
pp_palette <- c(
  "0.0369pM" = "lightblue",
  "0.369pM"  = "#99c2e6",
  "3.69pM"   = "#66a3d2",
  "36pM"     = "#3380bf",
  "369pM"    = "#004080"
)

# Define comparisons for significance bars

signif_comparisons <- list(
  c("0.0369pM", "369pM"),
   c("0.369pM", "369pM"),
  c("3.69pM", "369pM"),
  c("36pM", "369pM")
)


max_bio_plot <- ggplot(summary_stats, aes(x = Treatment)) +
  # Replicate points
  geom_point(
    data = max_bio,
    aes(y = Max_Chl, color = Treatment),
    size = 5, alpha = 0.6, , position = position_jitter(width = 0.1)
  ) +
  
  # Set visible range safely
  coord_cartesian(ylim = c(500, 10000)) +
  
  
  # Mean ± SD error bars (colored)
  geom_errorbar(
    aes(ymin = mean_chl - sd_chl, ymax = mean_chl + sd_chl, color = Treatment),
    width = 0.2,
    size = 1
  ) +
  
  # Mean points (open circle, stroke colored)
  geom_point(
    aes(y = mean_chl, color = Treatment),
    shape = 21, size = 5, stroke = 1.2
  ) +
 
#Optional comparison bars 
#   geom_signif(
#   comparisons = signif_comparisons,
#   y_position = c(1.1*max(max_bio$Max_Chl, na.rm = TRUE),
#                  1.15*max(max_bio$Max_Chl, na.rm = TRUE),
#                  1.2*max(max_bio$Max_Chl, na.rm = TRUE),
#                  1.25*max(max_bio$Max_Chl, na.rm = TRUE)),
#   annotations = "",
#   tip_length = 0.03,
#   color = "black",
#   aes(y = mean_chl)   # explicitly map y
# )+
#   
  # Color palette
  scale_color_manual(values = pp_palette) +
  
 
  scale_y_continuous()+
  ylab(expression(paste("Maximum RFU"))) +
  xlab(expression(B[12]~Concentration~"(pM)")) +
  
  # Theme
  theme_minimal() +
  theme(
    panel.border = element_rect(fill = NA, color = "black"),
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20, color = "black"),
    axis.text.x = element_text(size = 20, color = "black", angle =45, hjust =1),
    axis.title.y = element_text(family = "Arial", size = 20),
    axis.title.x = element_text(size = 20),
    legend.position = "none"
  )

max_bio_plot
```
```{r}
ggsave("b12_lev.png", width = 7, height = 10)
```

# ANOVA and post-hoc multiple comparisons of maximum biomass among varying media treatments
```{r}
result<- aov(Max_Chl~Treatment, max_bio)
summary(result)

TukeyHSD(result)

#            Df   Sum Sq  Mean Sq F value   Pr(>F)    
# Treatment    4 52576804 13144201   34.45 3.66e-06 ***
# Residuals   11  4197093   381554                     
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# > 
# > TukeyHSD(result)
#   Tukey multiple comparisons of means
#     95% family-wise confidence level
# 
# Fit: aov(formula = Max_Chl ~ Treatment, data = max_bio)
# 
# $Treatment
#                        diff       lwr       upr     p adj
# 36pM-369pM         390.8033 -1240.276  2021.883 0.9327149
# 3.69pM-369pM     -2417.3467 -4048.426  -786.267 0.0040496
# 0.369pM-369pM    -3309.7200 -4835.455 -1783.985 0.0001726
# 0.0369pM-369pM   -4312.9433 -5944.023 -2681.864 0.0000273
# 3.69pM-36pM      -2808.1500 -4439.230 -1177.070 0.0012586
# 0.369pM-36pM     -3700.5233 -5226.259 -2174.788 0.0000619
# 0.0369pM-36pM    -4703.7467 -6334.826 -3072.667 0.0000118
# 0.369pM-3.69pM    -892.3733 -2418.109   633.362 0.3753586
# 0.0369pM-3.69pM  -1895.5967 -3526.676  -264.517 0.0211988
# 0.0369pM-0.369pM -1003.2233 -2528.959   522.512 0.2753904
```
# Combine plots
```{r}
bo <- 
  (growth / 
   (max_bio_plot | mu) + theme(legend.position = "none")) + 
  plot_layout(
   
    guides = "collect",
      # controls vertical space for rows
    widths = c(4, 2)     # controls horizontal space for columns (if applicable)
  ) &
  theme(
    legend.position = "bottom",
    panel.spacing = unit(.1, "lines"),
    plot.margin = margin(15, 15, 15, 15),
    axis.title.y = element_text(margin = margin(r = 12)),
    axis.title.x = element_text(margin = margin(t = 8)),
    legend.margin = margin(t = 4, b = 4),
    legend.box.margin = margin(5, 5, 5, 5),
    axis.text.x = element_text(size = 16)
  )




bo




ggsave("b12_lev_combo.png", height = 10, width =10, dpi = 600 )
```
# Combine plots
```{r}
library(patchwork)
library(grid)

design <- "
A
B
C
"

bo <- (
  growth +                                  # keep legend from this one
  max_bio + theme(legend.position = "none") +
  mu + theme(legend.position = "none")
) +
  plot_layout(
    design = design,
    guides = "collect"                      # collect legend across plots
  ) &
  theme(
    legend.position = "bottom",             # move collected legend to bottom
    panel.spacing = unit(.1, "lines"),
    plot.margin = margin(15, 15, 15, 15),
    axis.title.y = element_text(margin = margin(r = 12)),
    axis.title.x = element_text(margin = margin(t = 8)),
    legend.margin = margin(t = 4, b = 4),
    legend.box.margin = margin(5, 5, 5, 5),
    axis.text.x = element_text(size = 16)
  )

bo


ggsave("b12_lev_combo.png", height = 16, width =10, dpi = 600 )
```